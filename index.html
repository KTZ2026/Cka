<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CKA 模擬考 — 150 題（升級版）</title>
<style>
  :root{--primary:#2563eb;--ok:#10b981;--muted:#6b7280}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Arial;margin:12px;background:#f7f9fc;color:#0f172a}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06);margin-top:12px}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--primary);color:#fff}
  .btn-ghost{background:transparent;border:1px solid #e5e7eb;color:#111}
  .small{font-size:0.9rem;color:var(--muted)}
  .qbox{margin-top:12px;padding:10px;background:#fff;border-radius:8px}
  .option{margin:6px 0}
  .result{margin-top:12px;padding:10px;background:#ecfccb;border-radius:8px}
  input[type="number"]{width:80px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  label.inline{display:inline-flex;align-items:center;gap:6px}
  .timer{font-weight:700}
</style>
</head>
<body>
  <div class="card">
    <h2>CKA 模擬考系統 — 150 題（升級版）</h2>
    <div class="small">離線 • iOS 相容 • 支援計時、匯出錯題與題庫下載</div>
  </div>

  <div class="card" id="setup">
    <div><strong>選擇主題（可多選）</strong></div>
    <div id="topicList"></div>

    <div style="margin-top:8px"><strong>難度</strong></div>
    <div class="controls">
      <label class="inline"><input type="radio" name="difficulty" value="mixed" checked> 全部</label>
      <label class="inline"><input type="radio" name="difficulty" value="easy"> 簡單</label>
      <label class="inline"><input type="radio" name="difficulty" value="medium"> 中等</label>
      <label class="inline"><input type="radio" name="difficulty" value="hard"> 困難</label>
    </div>

    <div style="margin-top:8px" class="controls">
      <label>題數 <input id="numQ" type="number" value="10" min="1" max="150"></label>
      <label class="inline"><input id="timedMode" type="checkbox"> 計時模式</label>
      <label>時長（分鐘） <input id="timeMinutes" type="number" value="30" min="1" style="width:80px"></label>
      <button class="btn" id="startBtn">開始模擬考</button>
      <button class="btn btn-ghost" id="downloadBank">下載題庫 JSON</button>
      <button class="btn btn-ghost" id="importBtn">匯入題庫（JSON）</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
      <button class="btn btn-ghost" id="viewHistory">作答紀錄</button>
    </div>
  </div>

  <div id="examArea" class="card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div id="status" class="small"></div>
      <div><span class="small">倒數：</span> <span id="timerDisplay" class="timer">--:--</span></div>
    </div>

    <div id="qContainer"></div>

    <div style="margin-top:10px" class="controls">
      <button class="btn" id="prevBtn">上一題</button>
      <button class="btn" id="nextBtn">下一題</button>
      <button class="btn" id="saveBtn">暫存答案</button>
      <button class="btn" id="submitBtn" style="background:var(--ok)">交卷</button>
    </div>
  </div>

  <div id="resultArea" class="card" style="display:none"></div>

  <div id="historyModal" class="card" style="display:none">
    <h3>作答紀錄</h3>
    <div id="historyList"></div>
    <button class="btn" id="closeHistory">關閉</button>
  </div>

<script>
/* ------------------------------------------
   內建題庫（150 題） — 升級版真實題庫示例
   若要用你自己的題庫，可按「匯入題庫（JSON）」上傳
   ------------------------------------------ */
const BANK = /* BANK_JSON_PLACEHOLDER */ [];

/* ---------- UI, state ---------- */
const TOPICS = [...new Set(BANK.map(q=>q.topic))];
const LS_KEY = 'cka_real_v1_records';
let currentExam = [], currentIndex = 0, answers = {};
let timerId = null, remainingSec = 0;

/* populate topic list */
const topicListEl = document.getElementById('topicList');
TOPICS.forEach(t=>{
  const lbl = document.createElement('label');
  lbl.className = 'inline';
  const cb = document.createElement('input'); cb.type='checkbox'; cb.name='topic'; cb.value=t;
  lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' ' + t));
  topicListEl.appendChild(lbl); topicListEl.appendChild(document.createElement('br'));
});

/* helpers */
function getSelectedTopics(){ return Array.from(document.querySelectorAll('input[name=topic]:checked')).map(e=>e.value); }
function getSelectedDifficulty(){ const r = document.querySelector('input[name=difficulty]:checked'); return r? r.value: 'mixed'; }
function sampleQuestions(num, topics, difficulty){
  let pool = BANK.slice();
  if(topics && topics.length) pool = pool.filter(q=> topics.indexOf(q.topic)!==-1);
  if(difficulty && difficulty!=='mixed') pool = pool.filter(q=> q.difficulty === difficulty);
  for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]]; }
  return pool.slice(0, num);
}

/* download bank JSON */
document.getElementById('downloadBank').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(BANK,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'cka_bank_150.json'; a.click();
});

/* import bank JSON */
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader(); reader.onload = ()=> {
    try {
      const data = JSON.parse(reader.result);
      if(Array.isArray(data)) {
        // replace dynamic BANK by copying entries (this page uses constant BANK, but we allow runtime override)
        window.BANK_OVERRIDE = data;
        alert('已匯入題庫（在本次封測會使用）。請按「開始模擬考」。');
      } else alert('題庫格式錯誤，應為題目陣列。');
    } catch(err){ alert('解析 JSON 發生錯誤：' + err.message); }
  }; reader.readAsText(f);
});

/* start exam */
document.getElementById('startBtn').addEventListener('click', startExam);
function startExam(){
  const num = Math.max(1, Math.min(150, parseInt(document.getElementById('numQ').value)||10));
  const chosenTopics = getSelectedTopics();
  const difficulty = getSelectedDifficulty();
  const useBank = window.BANK_OVERRIDE? window.BANK_OVERRIDE : BANK;
  const pool = (function(){ let p = useBank.slice(); if(chosenTopics.length) p = p.filter(q=> chosenTopics.indexOf(q.topic)!==-1); if(difficulty!=='mixed') p = p.filter(q=> q.difficulty===difficulty); for(let i=p.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [p[i],p[j]]=[p[j],p[i]]; } return p.slice(0,num); })();
  if(pool.length === 0){ alert('沒有符合條件的題目，請調整主題或難度。'); return; }
  currentExam = pool; currentIndex = 0; answers = {};
  document.getElementById('examArea').style.display = 'block';
  document.getElementById('resultArea').style.display = 'none';
  // timer
  if(document.getElementById('timedMode').checked){
    const mins = Math.max(1, parseInt(document.getElementById('timeMinutes').value)||30);
    remainingSec = mins * 60;
    startTimer();
  } else { stopTimer(); document.getElementById('timerDisplay').innerText = '--:--'; }
  renderQuestion(); updateStatus();
}

/* render question (createElement - iOS friendly) */
function renderQuestion(){
  const q = currentExam[currentIndex];
  const container = document.getElementById('qContainer');
  while(container.firstChild) container.removeChild(container.firstChild);
  const title = document.createElement('div'); title.innerHTML = '<strong>題 ' + (currentIndex+1) + ' / ' + currentExam.length + '</strong> <span class="small"> ' + q.topic + ' • ' + q.difficulty + '</span>';
  container.appendChild(title);
  const qbox = document.createElement('div'); qbox.className='qbox';
  const qtext = document.createElement('div'); qtext.innerText = q.question; qbox.appendChild(qtext);
  qbox.appendChild(document.createElement('br'));
  if(q.type === 'mc'){
    q.options.forEach((opt,i)=>{
      const p = document.createElement('div'); p.className='option';
      const label = document.createElement('label'); label.className='inline';
      const radio = document.createElement('input'); radio.type='radio'; radio.name=q.id; radio.value=i;
      if(answers[q.id] !== undefined && parseInt(answers[q.id])===i) radio.checked=true;
      label.appendChild(radio); label.appendChild(document.createTextNode(opt));
      p.appendChild(label); qbox.appendChild(p);
    });
  } else if(q.type === 'yaml'){
    const pre = document.createElement('pre'); pre.textContent = q.template || ''; qbox.appendChild(pre);
    const inp = document.createElement('input'); inp.type='text'; inp.name=q.id; inp.style.width='100%'; inp.placeholder='填入 YAML 的答案片段';
    if(answers[q.id]) inp.value = answers[q.id]; qbox.appendChild(inp);
  } else if(q.type === 'cmd'){
    const inp = document.createElement('input'); inp.type='text'; inp.name=q.id; inp.style.width='100%'; inp.placeholder='輸入命令，例如: kubectl get pods';
    if(answers[q.id]) inp.value = answers[q.id]; qbox.appendChild(inp);
  }
  // explain toggle (hidden until graded)
  const explainDiv = document.createElement('div'); explainDiv.className='small'; explainDiv.style.display='none'; explainDiv.id='explainDiv';
  if(q.explain) explainDiv.innerText = '提示/解析：' + q.explain;
  qbox.appendChild(explainDiv);
  container.appendChild(qbox);
}

/* navigation */
document.getElementById('nextBtn').addEventListener('click', ()=>{
  saveCurrentAnswer(); if(currentIndex < currentExam.length-1){ currentIndex++; renderQuestion(); updateStatus(); }
});
document.getElementById('prevBtn').addEventListener('click', ()=>{
  saveCurrentAnswer(); if(currentIndex > 0){ currentIndex--; renderQuestion(); updateStatus(); }
});
document.getElementById('saveBtn').addEventListener('click', ()=>{ saveCurrentAnswer(); alert('已暫存目前題目答案'); });

function saveCurrentAnswer(){
  const q = currentExam[currentIndex]; if(!q) return;
  if(q.type === 'mc'){ const checked = document.querySelector('input[name="'+ q.id +'"]:checked'); if(checked) answers[q.id] = checked.value; }
  else { const inp = document.querySelector('input[name="'+ q.id +'"]'); if(inp) answers[q.id] = inp.value.trim(); }
}

function updateStatus(){ document.getElementById('status').innerText = '題目 ' + (currentIndex+1) + ' / ' + currentExam.length; }

/* timer */
function startTimer(){
  stopTimer();
  updateTimerDisplay();
  timerId = setInterval(()=>{
    remainingSec--;
    if(remainingSec <= 0){ stopTimer(); autoSubmit(); }
    updateTimerDisplay();
  }, 1000);
}
function stopTimer(){ if(timerId) { clearInterval(timerId); timerId = null; } }
function updateTimerDisplay(){ const mm = String(Math.floor(remainingSec/60)).padStart(2,'0'); const ss = String(remainingSec%60).padStart(2,'0'); document.getElementById('timerDisplay').innerText = mm + ':' + ss; }

/* auto submit on timeout */
function autoSubmit(){
  saveCurrentAnswer();
  alert('計時結束，自動交卷');
  gradeAndShow();
}

/* submit button */
document.getElementById('submitBtn').addEventListener('click', ()=>{
  saveCurrentAnswer();
  if(!confirm('確認交卷？')) return;
  gradeAndShow();
});

/* grading, store history, export wrong answers */
function gradeAndShow(){
  stopTimer();
  let correct = 0, review = [];
  currentExam.forEach(q=>{
    const user = answers[q.id];
    let ok = false;
    if(q.type === 'mc'){ ok = (user !== undefined && parseInt(user) === q.answer); }
    else if(q.type === 'yaml'){ ok = user && q.answer && user.toLowerCase().indexOf(q.answer.toLowerCase()) !== -1; }
    else if(q.type === 'cmd'){ ok = user && q.answer && user.toLowerCase().indexOf(q.answer.toLowerCase()) !== -1; }
    if(ok) correct++; else review.push({q:q, given: user});
  });
  const score = Math.round((correct / currentExam.length) * 100);
  // save history
  const hist = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  hist.unshift({ts:Date.now(),score:score,correct:correct,total:currentExam.length,difficulty:getSelectedDifficulty()});
  localStorage.setItem(LS_KEY, JSON.stringify(hist.slice(0,50)));
  // show result
  const ra = document.getElementById('resultArea'); ra.style.display='block';
  ra.innerHTML = `<div class="result"><strong>得分: ${score}% (${correct}/${currentExam.length})</strong></div>`;
  if(review.length){
    const revdiv = document.createElement('div'); revdiv.innerHTML = '<h4>錯題回顧</h4>';
    review.forEach(it=>{
      const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid #eee';
      d.innerHTML = `<div><strong>題目：</strong>${it.q.question}</div><div><strong>你的答案：</strong>${it.given || '(未作答)'}</div><div><strong>正確：</strong>${it.q.type==='mc'? it.q.options[it.q.answer] : '<pre>' + (it.q.answer || '') + '</pre>'}</div><div class="small">${it.q.explain || ''}</div>`;
      revdiv.appendChild(d);
    });
    // export wrong answers button
    const expBtn = document.createElement('button'); expBtn.className='btn btn-ghost'; expBtn.innerText='匯出錯題 (JSON)';
    expBtn.onclick = ()=> {
      const blob = new Blob([JSON.stringify(review,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='cka_wrong_questions.json'; a.click();
    };
    revdiv.appendChild(document.createElement('br')); revdiv.appendChild(expBtn);
    ra.appendChild(revdiv);
  }
  document.getElementById('examArea').style.display='none';
}

/* history modal */
document.getElementById('viewHistory').addEventListener('click', ()=>{
  const modal = document.getElementById('historyModal'); const list = document.getElementById('historyList'); list.innerHTML='';
  const hist = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
  if(hist.length === 0) list.innerHTML = '<div class="small">尚無紀錄</div>';
  hist.forEach(h=>{
    const el = document.createElement('div'); el.className='history-item';
    const d = new Date(h.ts);
    el.innerHTML = `<div><strong>${h.score}%</strong> • ${h.correct}/${h.total}</div><div class="small">${d.toLocaleString()} • difficulty: ${h.difficulty}</div>`;
    list.appendChild(el);
  });
  modal.style.display='block';
});
document.getElementById('closeHistory').addEventListener('click', ()=> document.getElementById('historyModal').style.display='none');

/* Accessibility: keyboard enter submit for text fields (optional) */
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter' && document.activeElement && document.activeElement.tagName === 'INPUT') {
    // noop or save answer
    saveCurrentAnswer();
  }
});

/* If BANK is empty (placeholder), show message */
if(!BANK || BANK.length === 0){
  const s = document.createElement('div'); s.className='card'; s.style.background='#fff3f2'; s.innerHTML = '<strong>注意：</strong> 目前題庫為空。請上傳或按下載範例題庫。';
  document.body.insertBefore(s, document.getElementById('setup'));
}

/* End of script */
</script>
</body>
</html>
